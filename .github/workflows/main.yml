name: Provision and Deploy (OIDC)

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  run-all:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}  
          enable-AzPSSession: true

      - name: Run provisioning script
        shell: pwsh
        run: |
          cd scripts
          ./provision.ps1
          if (-not (Test-Path "outputs.json")) {
            Write-Error "outputs.json not found, provisioning failed"
            exit 1
          }

      - name: Parse outputs.json
        id: parse
        shell: pwsh
        run: |
          $outputs = Get-Content scripts/outputs.json | ConvertFrom-Json
          $FN_NAME = $outputs.functionApp.name
          $KV_NAME = $outputs.keyVault.name
          $RG_NAME = $outputs.resourceGroup
          if ([string]::IsNullOrEmpty($FN_NAME)) { Write-Error "Missing functionApp.name in outputs.json"; exit 1 }
          if ([string]::IsNullOrEmpty($KV_NAME)) { Write-Error "Missing keyVault.name in outputs.json"; exit 1 }
          if ([string]::IsNullOrEmpty($RG_NAME)) { Write-Error "Missing resourceGroup in outputs.json"; exit 1 }
          "fn_name=$FN_NAME" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "kv_name=$KV_NAME" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "rg_name=$RG_NAME" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Build function app
        working-directory: FunctionApp/FunctionAppACS
        run: |
          dotnet restore
          dotnet publish -c Release -o publish

      - name: Package function zip
        shell: pwsh
        run: |
          cd FunctionApp/FunctionAppACS/publish
          Compress-Archive -Path * -DestinationPath ../../../deploy.zip -Force

      - name: Deploy zip to Function App
        shell: pwsh
        run: |
          $FN = "${{ steps.parse.outputs.fn_name }}"
          $RG = "${{ steps.parse.outputs.rg_name }}"
          az functionapp deployment source config-zip -g $RG -n $FN --src ./deploy.zip

      - name: Configure app settings (KEY_VAULT_URI and CALLBACK_URI)
        shell: pwsh
        run: |
          $FN = "${{ steps.parse.outputs.fn_name }}"
          $KV = "${{ steps.parse.outputs.kv_name }}"
          $RG = "${{ steps.parse.outputs.rg_name }}"
          $KV_URI = "https://$KV.vault.azure.net/"
          $CALLBACK = "https://$FN.azurewebsites.net/api/CallEvents"
          az functionapp config appsettings set -g $RG -n $FN --settings KEY_VAULT_URI=$KV_URI CALLBACK_URI=$CALLBACK

      - name: Wait for Function App to be ready
        shell: pwsh
        run: |
          Write-Host "Waiting for Function App to fully start..."
          Start-Sleep -Seconds 30

      - name: Fetch function key and smoke test
        shell: pwsh
        run: |
          $FN = "${{ steps.parse.outputs.fn_name }}"
          $RG = "${{ steps.parse.outputs.rg_name }}"
          
          # Retry logic for getting function keys
          $maxRetries = 5
          $retryCount = 0
          $KEY = $null
          
          while ($retryCount -lt $maxRetries -and [string]::IsNullOrEmpty($KEY)) {
            try {
              Write-Host "Attempting to fetch function keys (attempt $($retryCount + 1)/$maxRetries)..."
              $KEY_JSON = az functionapp function keys list -g $RG -n $FN --function-name MakeCall -o json 2>&1
              if ($LASTEXITCODE -eq 0) {
                $KEY_OBJ = $KEY_JSON | ConvertFrom-Json
                $KEY = $KEY_OBJ.default
                if (-not [string]::IsNullOrEmpty($KEY)) {
                  Write-Host "Successfully retrieved function key"
                  break
                }
              }
            } catch {
              Write-Host "Attempt failed: $_"
            }
            
            $retryCount++
            if ($retryCount -lt $maxRetries) {
              Write-Host "Waiting 15 seconds before retry..."
              Start-Sleep -Seconds 15
            }
          }
          
          if ([string]::IsNullOrEmpty($KEY)) {
            Write-Warning "Could not fetch function key after $maxRetries attempts. Function may need more time to initialize."
            Write-Host "You can test manually later using: az functionapp function keys list -g $RG -n $FN --function-name MakeCall"
            exit 0
          }
          
          $URL = "https://$FN.azurewebsites.net/api/MakeCall?code=$KEY"
          Write-Host "Calling $URL (smoke test)"
          $body = @{
            to = "+441234567890"
            from = "+15551234567"
          } | ConvertTo-Json
          try {
            Invoke-RestMethod -Uri $URL -Method POST -Body $body -ContentType "application/json"
            Write-Host "Smoke test completed"
          } catch {
            Write-Host "Smoke test call failed (expected if no valid phone numbers): $_"
          }
