name: Provision and Deploy (OIDC)

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  run-all:
    runs-on: windows-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Azure login using OIDC
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}  
          enable-AzPSSession: true

      - name: Run provisioning script
        shell: pwsh
        run: |
          cd scripts
          ./provision.ps1
          cd ..
          if (-not (Test-Path "outputs.json")) {
            Write-Error "outputs.json not found, provisioning failed"
            exit 1
          }

      - name: Parse outputs.json
        id: parse
        shell: pwsh
        run: |
          $outputs = Get-Content outputs.json | ConvertFrom-Json
          $FN_NAME = $outputs.functionApp.name
          $KV_NAME = $outputs.keyVault.name
          $RG_NAME = $outputs.resourceGroup
          if ([string]::IsNullOrEmpty($FN_NAME)) { Write-Error "Missing functionApp.name in outputs.json"; exit 1 }
          if ([string]::IsNullOrEmpty($KV_NAME)) { Write-Error "Missing keyVault.name in outputs.json"; exit 1 }
          if ([string]::IsNullOrEmpty($RG_NAME)) { Write-Error "Missing resourceGroup in outputs.json"; exit 1 }
          "fn_name=$FN_NAME" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "kv_name=$KV_NAME" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
          "rg_name=$RG_NAME" | Out-File -FilePath $env:GITHUB_OUTPUT -Append

      - name: Build function app
        working-directory: FunctionApp/FunctionAppACS
        run: |
          dotnet restore
          dotnet publish -c Release -o publish

      - name: Package function zip
        shell: pwsh
        run: |
          cd FunctionApp/FunctionAppACS/publish
          Compress-Archive -Path * -DestinationPath ../../../deploy.zip -Force

      - name: Deploy zip to Function App
        shell: pwsh
        run: |
          $FN = "${{ steps.parse.outputs.fn_name }}"
          $RG = "${{ steps.parse.outputs.rg_name }}"
          az functionapp deployment source config-zip -g $RG -n $FN --src ./deploy.zip

      - name: Configure app settings (KEY_VAULT_URI and CALLBACK_URI)
        shell: pwsh
        run: |
          $FN = "${{ steps.parse.outputs.fn_name }}"
          $KV = "${{ steps.parse.outputs.kv_name }}"
          $RG = "${{ steps.parse.outputs.rg_name }}"
          $KV_URI = "https://$KV.vault.azure.net/"
          $CALLBACK = "https://$FN.azurewebsites.net/api/CallEvents"
          az functionapp config appsettings set -g $RG -n $FN --settings KEY_VAULT_URI=$KV_URI CALLBACK_URI=$CALLBACK

      - name: Fetch function key and smoke test
        shell: pwsh
        run: |
          $FN = "${{ steps.parse.outputs.fn_name }}"
          $RG = "${{ steps.parse.outputs.rg_name }}"
          $KEY_JSON = az functionapp function keys list -g $RG -n $FN --function-name MakeCall -o json | ConvertFrom-Json
          $KEY = $KEY_JSON.default
          if ([string]::IsNullOrEmpty($KEY)) {
            Write-Error "Could not fetch function key"
            exit 1
          }
          $URL = "https://$FN.azurewebsites.net/api/MakeCall?code=$KEY"
          Write-Host "Calling $URL (smoke test)"
          $body = @{
            to = "+441234567890"
            from = "+15551234567"
          } | ConvertTo-Json
          try {
            Invoke-RestMethod -Uri $URL -Method POST -Body $body -ContentType "application/json"
          } catch {
            Write-Host "Smoke test call failed (expected): $_"
          }
